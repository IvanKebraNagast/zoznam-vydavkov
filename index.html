<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sledovanie v√Ωdavkov</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
<!-- Highcharts Scripty -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/highcharts-3d.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
body {
    font-family: 'Inter', sans-serif;
    /* üî• 1. Z√ÅKLAD: Zak√°≈æeme scrollovanie celej str√°nky do strany */
    overflow-x: hidden; 
    width: 100vw;
}

.modal {
    background-color: rgba(0, 0, 0, 0.5);
    transition: opacity 0.3s ease-in-out;
}
.modal-content {
    animation: fadeInScale 0.3s ease-in-out forwards;
}
.sidebar {
    transition: transform 0.3s ease-in-out;
}
@keyframes fadeInScale {
    from {
        opacity: 0;
        transform: scale(0.95);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}
.highcharts-credits {
    display: none;
}

/* ========================================= */
/* üî• 2. OPRAVA GRAFU (Highcharts)           */
/* ========================================= */
/* Povol√≠me SVG preteka≈• len v r√°mci svojho kontajnera, ak treba, 
   ale hlavn√∫ opravu sprav√≠me zmen≈°en√≠m grafu v JS */
.highcharts-container, 
#myChart svg {
    overflow: visible !important;
}

/* ========================================= */
/* üî• 3. TABUƒΩKA (Swipe efekt)               */
/* ========================================= */
.table-container {
    /* Toto zabezpeƒç√≠, ≈æe tabuƒæka sa d√° pos√∫va≈• prstom, ak je ≈°ir≈°ia ako mobil */
    overflow-x: auto !important; 
    -webkit-overflow-scrolling: touch; 
    width: 100%;
    display: block;
}

/* Vyn√∫time, aby sa text v tabuƒæke nezalamoval -> to vytvor√≠ potrebu scrollova≈• */
.expenses-table td, 
.expenses-table th {
    white-space: nowrap !important;
    padding-left: 1rem;
    padding-right: 1rem;
}

/* ========================================= */

#myChart {
    min-height: 500px !important;
}

@media (max-width: 768px) {
    #myChart {
        min-height: 500px !important; 
    }
    h1 { font-size: 1.5rem !important; }
    .container { padding: 1rem !important; }
}

@media print {
    .no-print { display: none !important; }
    body, html { height: auto; overflow: visible; margin: 0; padding: 0; }
    #pie-chart-section, #myChart {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        transform: none !important;
    }
    #myChart { height: 500px !important; width: 700px !important; }
    .table-container { overflow-x: visible !important; }
    .expenses-table td, .expenses-table th { white-space: normal !important; }
}
</style>
</head>
<body class="bg-gray-100 flex min-h-screen p-4">

<!-- Hlavn√Ω obsah -->
<div id="main-content" class="container mx-auto bg-white shadow-xl rounded-2xl p-8 space-y-8 max-w-4xl">

<header class="text-center">
<h1 class="text-4xl font-bold text-blue-900 mb-2">Sledovanie v√Ωdavkov</h1>
<div class="inline-block px-4 py-1.5 bg-gray-200 rounded-full text-gray-700 text-sm font-medium">
Vytvoril: IvanKebraNagast
</div>
<p id="cycle-dates" class="text-gray-600">Sledovanie rozpoƒçtu.</p>
</header>

<!-- Spr√°va cyklov -->
<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 flex flex-col md:flex-row items-center justify-between gap-4 no-print">
<h2 class="text-xl font-bold text-gray-800">Spr√°va cyklov</p>
<div class="flex gap-4 w-full md:w-auto">
<button id="start-new-cycle-btn" class="flex-1 px-6 py-2.5 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 focus:ring-4 focus:ring-blue-500 focus:outline-none">
Ukonƒçi≈• aktu√°lny cyklus a zaƒça≈• nov√Ω
</button>
<button id="view-history-btn" class="flex-1 px-6 py-2.5 bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 focus:ring-4 focus:ring-gray-500 focus:outline-none">
Zobrazi≈• hist√≥riu
</button>
</div>
</section>

<!-- Formul√°re -->
<div id="current-cycle-forms">
<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 grid grid-cols-1 md:grid-cols-3 gap-4 no-print">
<div class="flex flex-col items-start space-y-2">
<label for="monthly-income-input" class="text-sm font-medium text-gray-700">Celkov√Ω pr√≠jem (‚Ç¨)</label>
<input type="number" id="monthly-income-input" placeholder="0.00" step="0.01" class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
<button id="save-income-btn" class="w-full px-6 py-2.5 bg-green-600 text-white font-bold rounded-lg shadow-md hover:bg-green-700 focus:ring-4 focus:ring-green-500 focus:outline-none">Ulo≈æi≈• pr√≠jem</button>
</div>
<div class="flex flex-col items-center justify-center bg-blue-100 p-4 rounded-lg">
<span class="text-sm font-medium text-blue-800">Minul som</span>
<span id="total-spent" class="text-2xl font-bold text-blue-600 mt-1">0.00 ‚Ç¨</span>
</div>
<div id="remaining-budget-container" class="flex flex-col items-center justify-center p-4 rounded-lg">
<span class="text-sm font-medium text-green-800">Zost√°va mi</span>
<span id="remaining-budget" class="text-2xl font-bold mt-1">0.00 ‚Ç¨</span>
</div>
</section>

<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 no-print">
<h2 class="text-2xl font-bold text-gray-800 mb-4">Rozpoƒçtov√© pravidlo</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
<div class="input-group">
<label for="budget-category-select" class="block text-sm text-gray-700 mb-1">Polo≈æka pre rozpoƒçet</label>
<select id="budget-category-select" class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
</select>
</div>
<div class="input-group">
<label for="budget-amount-input" class="block text-sm text-gray-700 mb-1">Rozpoƒçet (‚Ç¨)</label>
<input type="number" id="budget-amount-input" placeholder="100.00" step="0.01" class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
</div>
<button id="save-budget-btn" class="w-full px-6 py-2.5 bg-yellow-600 text-white font-bold rounded-lg shadow-md hover:bg-yellow-700 focus:ring-4 focus:ring-yellow-500 focus:outline-none">
Ulo≈æi≈• rozpoƒçet
</button>
</div>
<div id="budget-bar-chart-container" class="relative w-full max-w-2xl mx-auto mt-6 hidden">
<canvas id="budget-bar-chart"></canvas>
</div>
<div id="budget-status-container" class="mt-6 space-y-4"></div>
</section>

<section class="bg-gray-50 p-6 rounded-xl border border-gray-200 no-print">
<h2 class="text-2xl font-bold text-gray-800 mb-4">Prida≈• nov√Ω v√Ωdavok</h2>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
<div class="input-group" id="expense-category-container">
<label for="expense-category" class="block text-sm text-gray-700 mb-1">Polo≈æka</label>
<select id="expense-category" class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white">
</select>
</div>

<div class="input-group hidden" id="custom-category-input-group">
<label for="custom-category-input" class="block text-sm text-gray-700 mb-1">Vlastn√° polo≈æka</label>
<input type="text" id="custom-category-input" placeholder="Napr. Darƒçek pre Petra" class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
</div>

<div class="input-group">
<label for="expense-amount" class="block text-sm text-gray-700 mb-1">Suma (‚Ç¨)</label>
<input type="number" id="expense-amount" placeholder="50.00" step="0.01" class="w-full px-4 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500">
</div>
<button id="add-expense-btn" class="w-full px-6 py-2.5 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 focus:ring-4 focus:ring-blue-500 focus:outline-none">
Prida≈•
</button>
</div>
</section>
</div>

<div id="history-view-message" class="hidden bg-gray-200 p-6 rounded-xl text-center">
<p class="text-xl font-bold text-gray-700">Moment√°lne prezer√°te historick√Ω cyklus.</p>
</div>

<!-- Sekcia Grafu a Tabuƒæky -->
<section class="flex flex-col lg:flex-row gap-8">
<!-- Graf -->
<div id="pie-chart-section" class="flex-1 bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col items-center">
    <div id="myChart" style="width: 100%;"></div>
    <div id="custom-legend-container" class="w-full mt-6 grid grid-cols-1 md:grid-cols-2 gap-3"></div>
</div>

<!-- Tabuƒæka -->
<div class="flex-1 bg-gray-50 p-6 rounded-xl border border-gray-200 shadow-sm flex flex-col overflow-hidden">
<h2 class="text-2xl font-bold text-gray-800 mb-4">Prehƒæad v√Ωdavkov</h2>
<!-- Kontajner pre tabuƒæku so swipe efektom -->
<div class="table-container">
<table class="min-w-full table-auto text-center expenses-table">
<thead>
<tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
<th class="py-3 px-6 text-left">D√°tum a polo≈æka</th>
<th class="py-3 px-6 text-left">Suma (‚Ç¨)</th>
</tr>
</thead>
<tbody id="expense-table-body" class="text-gray-700 text-sm font-light">
</tbody>
</table>
</div>
<button id="delete-current-cycle-btn" class="mt-4 w-full px-6 py-2.5 bg-red-600 text-white font-bold rounded-lg shadow-md hover:bg-red-700 focus:ring-4 focus:ring-red-500 focus:outline-none no-print">
Vymaza≈• d√°ta aktu√°lneho cyklus
</button>
</div>
</section>

<!-- Tlaƒçidlo Tlaƒçi≈• -->
<section class="mt-4 flex justify-center">
<button id="print-all-btn" class="flex items-center gap-2 px-6 py-2.5 bg-gray-600 text-white font-bold rounded-lg shadow-md hover:bg-gray-700 focus:ring-4 focus:ring-gray-500 focus:outline-none">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="width: 1rem; height: 1rem; fill: currentColor;"><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64c0-17.7 14.3-32 32-32H352c17.7 0 32 14.3 32 32v96h64V64c0-35.3-28.7-64-64-64H128zM0 192c0-35.3 28.7-64 64-64H448c35.3 0 64 28.7 64 64v32V416c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V224 192zm64 64V416H448V256H64zM200 352h112c4.4 0 8-3.6 8-8c0-4.4-3.6-8-8-8H200c-4.4 0-8 3.6-8 8c0 4.4 3.6 8 8 8z"/></svg>
    Tlaƒçi≈•
</button>
</section>

<div id="message-box" class="fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-lg transition-all duration-300 hidden no-print" style="transform: translateX(-50%);">
<p id="message-text" class="font-medium text-white"></p>
</div>

<div id="confirmation-dialog" class="modal fixed inset-0 flex items-center justify-center p-4 z-50 hidden no-print">
<div class="modal-content bg-white rounded-xl shadow-2xl p-8 max-w-sm mx-auto space-y-6">
<h3 class="text-2xl font-bold text-gray-800">Potvrdenie</h3>
<p id="confirmation-message" class="text-gray-700"></p>
<div class="flex justify-end gap-4">
<button id="cancel-btn" class="px-6 py-2.5 bg-gray-300 text-gray-800 font-bold rounded-lg hover:bg-gray-400">Zru≈°i≈•</button>
<button id="confirm-btn" class="px-6 py-2.5 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700">Potvrdi≈•</button>
</div>
</div>
</div>

<div id="history-sidebar" class="sidebar fixed top-0 right-0 h-full w-80 bg-gray-900 text-white p-6 transform translate-x-full z-40 shadow-lg overflow-y-auto no-print">
<div class="flex justify-between items-center mb-6">
<h2 class="text-2xl font-bold">Hist√≥ria cyklov</h2>
<button id="close-history-btn" class="text-2xl font-bold hover:text-gray-400">√ó</button>
</div>
<div id="history-list" class="space-y-4"></div>
<button id="delete-history-btn" class="mt-4 w-full px-6 py-2.5 bg-red-600 text-white font-bold rounded-lg shadow-md hover:bg-red-700 focus:ring-4 focus:ring-red-500 focus:outline-none">Vymaza≈• cel√∫ hist√≥riu</button>
<button id="back-to-current-btn" class="mt-4 w-full px-6 py-2.5 bg-gray-500 text-white font-bold rounded-lg shadow-md hover:bg-gray-600 focus:ring-4 focus:ring-gray-400 focus:outline-none">Sp√§≈• na aktu√°lny cyklus</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let expenses = [];
let pieChart; 
let budgetChart;
let monthlyIncome = 0;
let monthlyBudget = {};
let messageTimeout;
let cycleStartDate = null; 

const currentCycleKey = 'expenseTrackerData-current';
const archiveKeyPrefix = 'expenseTrackerData-archived-';
let isHistoryView = false;

let expenseCategories = ['N√°jomn√©', 'Internet', 'Elektrika', 'K√∫renie', 'Poistka za auto', 'Poistenie zodpovednosti za byt', 'Potraviny', 'Doprava', 'Z√°bava', 'Cigarety', 'Alkohol', 'Ostatn√©'];
const CUSTOM_CATEGORY_OPTION = 'CUSTOM_CATEGORY_INPUT';

function getAllCategories() {
    let allCategories = new Set(expenseCategories);
    expenses.forEach(e => allCategories.add(e.category));
    Object.keys(monthlyBudget).forEach(b => allCategories.add(b));
    return Array.from(allCategories).sort();
}

function saveDataToLocalStorage(key = currentCycleKey) {
    const data = { expenses, monthlyIncome, monthlyBudget, cycleStartDate: cycleStartDate ? cycleStartDate.toISOString() : null };
    localStorage.setItem(key, JSON.stringify(data));
}

function loadDataFromLocalStorage(key = currentCycleKey) {
    try {
        const data = JSON.parse(localStorage.getItem(key));
        if (data) {
            expenses = data.expenses || [];
            monthlyIncome = data.monthlyIncome || 0;
            monthlyBudget = data.monthlyBudget || {};
            cycleStartDate = data.cycleStartDate ? new Date(data.cycleStartDate) : null;
            const incomeInput = document.getElementById('monthly-income-input');
            if(incomeInput) incomeInput.value = monthlyIncome;
        } else {
            expenses = []; monthlyIncome = 0; monthlyBudget = {}; cycleStartDate = null;
        }
    } catch (e) { console.error("Chyba d√°t", e); }
}

function renderAllUI() {
    try {
        const historyMessageEl = document.getElementById('history-view-message');
        const currentFormsEl = document.getElementById('current-cycle-forms');
        const chartSection = document.getElementById('pie-chart-section');
        const budgetRuleSection = document.querySelector('section:nth-of-type(3)');
        const deleteBtn = document.getElementById('delete-current-cycle-btn');
        const printBtn = document.getElementById('print-all-btn');

        renderUI(); 

        if (isHistoryView) {
            currentFormsEl?.classList.add('hidden');
            deleteBtn?.classList.add('hidden');
            historyMessageEl?.classList.remove('hidden');
            if(printBtn) printBtn.textContent = 'Vytlaƒçi≈• historick√Ω prehƒæad';
        } else {
            currentFormsEl?.classList.remove('hidden');
            deleteBtn?.classList.remove('hidden');
            historyMessageEl?.classList.add('hidden');
            if(printBtn) printBtn.textContent = 'Vytlaƒçi≈• prehƒæad';
            updateChart();
            updateBudgetRuleChart();
            updateBudgetStatus();
        }
        renderTable();
        updateBudgetSummary();
        updateCycleDatesDisplay();
    } catch (e) { console.error("Chyba UI", e); }
}

// ... (Ostatn√© pomocn√© funkcie ako startNewCycle, loadArchivedCycle ost√°vaj√∫ rovnak√©) ...
function startNewCycle() {
    if (expenses.length === 0 && monthlyIncome === 0) { showMessage('≈Ωiadne d√°ta.', 'error'); return; }
    showConfirmationDialog('Ukonƒçi≈• cyklus a zaƒça≈• nov√Ω?', () => {
        const endDate = new Date();
        const archiveKey = `${archiveKeyPrefix}${endDate.toISOString()}`;
        const dataToArchive = JSON.parse(localStorage.getItem(currentCycleKey));
        if (dataToArchive) {
            localStorage.setItem(archiveKey, JSON.stringify({ ...dataToArchive, cycleEndDate: endDate.toISOString() }));
        }
        expenses = []; monthlyIncome = 0; monthlyBudget = {}; cycleStartDate = null;
        saveDataToLocalStorage();
        document.getElementById('monthly-income-input').value = '';
        document.getElementById('budget-amount-input').value = '';
        isHistoryView = false; renderAllUI();
        showMessage('Nov√Ω cyklus spusten√Ω!', 'success');
    });
}
function loadArchivedCycle(key) {
    const data = JSON.parse(localStorage.getItem(key));
    if (data) {
        expenses = data.expenses || []; monthlyIncome = data.monthlyIncome || 0; monthlyBudget = data.monthlyBudget || {};
        cycleStartDate = data.cycleStartDate ? new Date(data.cycleStartDate) : null;
        isHistoryView = true;
        updateCycleDatesDisplay(cycleStartDate, data.cycleEndDate ? new Date(data.cycleEndDate) : null);
        document.getElementById('monthly-income-input').value = monthlyIncome;
        showMessage('Historick√Ω cyklus.', 'info');
        renderAllUI();
        document.getElementById('history-sidebar').classList.add('translate-x-full');
    }
}
function backToCurrentCycle() {
    loadDataFromLocalStorage(currentCycleKey);
    isHistoryView = false;
    document.getElementById('history-sidebar').classList.add('translate-x-full');
    showMessage('Aktu√°lny cyklus.', 'info');
    renderAllUI();
}
function renderHistorySidebar() {
    const list = document.getElementById('history-list'); list.innerHTML = '';
    const keys = Object.keys(localStorage).filter(k => k.startsWith(archiveKeyPrefix)).sort().reverse();
    if(keys.length === 0) { list.innerHTML = '<p class="text-gray-400">≈Ωiadna hist√≥ria.</p>'; return; }
    keys.forEach(key => {
        const data = JSON.parse(localStorage.getItem(key));
        const div = document.createElement('div');
        div.className = 'bg-gray-800 p-4 rounded-lg flex justify-between items-center';
        div.innerHTML = `<div class="cursor-pointer flex-grow"><h4 class="font-bold">Cyklus: ${new Date(data.cycleStartDate).toLocaleDateString()}</h4></div>`;
        div.firstChild.onclick = () => loadArchivedCycle(key);
        const del = document.createElement('button'); del.className='text-red-500 ml-4'; del.innerHTML='<i class="fas fa-trash"></i>';
        del.onclick = () => showConfirmationDialog('Vymaza≈• cyklus?', () => { localStorage.removeItem(key); renderHistorySidebar(); });
        div.appendChild(del);
        list.appendChild(div);
    });
}
function handleDeleteHistory() { showConfirmationDialog('Vymaza≈• cel√∫ hist√≥riu?', () => { Object.keys(localStorage).filter(k=>k.startsWith(archiveKeyPrefix)).forEach(k=>localStorage.removeItem(k)); renderHistorySidebar(); }); }
function showMessage(msg, type='success') {
    const box = document.getElementById('message-box');
    document.getElementById('message-text').textContent = msg;
    box.className = `fixed bottom-4 left-1/2 -translate-x-1/2 p-4 rounded-xl shadow-lg transition-all duration-300 ${type==='error'?'bg-red-500':'bg-green-500'}`;
    clearTimeout(messageTimeout);
    messageTimeout = setTimeout(() => box.classList.add('hidden'), 3000);
}
function showConfirmationDialog(msg, onConfirm) {
    const d = document.getElementById('confirmation-dialog');
    document.getElementById('confirmation-message').textContent = msg;
    d.classList.remove('hidden');
    const y = document.getElementById('confirm-btn'), n = document.getElementById('cancel-btn');
    const close = () => { d.classList.add('hidden'); y.onclick=null; n.onclick=null; };
    y.onclick = () => { onConfirm(); close(); }; n.onclick = close;
}
// ... (Event handlery pre prid√°vanie v√Ωdavkov atƒè.) ...
function handleAddExpense() {
    if(isHistoryView) return;
    const amt = parseFloat(document.getElementById('expense-amount').value);
    if(isNaN(amt) || amt<=0) { showMessage('Zl√° suma', 'error'); return; }
    let cat = document.getElementById('expense-category').value;
    if(cat === CUSTOM_CATEGORY_OPTION) cat = document.getElementById('custom-category-input').value.trim();
    if(!cat) { showMessage('Ch√Ωba n√°zov', 'error'); return; }
    expenses.push({ date: new Date().toISOString(), category: cat, amount: amt });
    saveDataToLocalStorage(); renderAllUI();
    document.getElementById('expense-amount').value = '';
    showMessage('V√Ωdavok pridan√Ω');
}
function handleSaveIncome() {
    if(isHistoryView) return;
    const val = parseFloat(document.getElementById('monthly-income-input').value);
    if(isNaN(val)) return;
    monthlyIncome = val; if(!cycleStartDate) cycleStartDate = new Date();
    saveDataToLocalStorage(); renderAllUI(); showMessage('Pr√≠jem ulo≈æen√Ω');
}
function handleSaveBudget() {
    if(isHistoryView) return;
    const cat = document.getElementById('budget-category-select').value;
    const val = parseFloat(document.getElementById('budget-amount-input').value);
    if(isNaN(val)) return;
    monthlyBudget[cat] = val; saveDataToLocalStorage(); renderAllUI(); showMessage('Rozpoƒçet ulo≈æen√Ω');
}
function handleDeleteCurrentCycle() {
    if(isHistoryView) return;
    showConfirmationDialog('Vymaza≈• aktu√°lne d√°ta?', () => { expenses=[]; monthlyIncome=0; monthlyBudget={}; cycleStartDate=null; saveDataToLocalStorage(); renderAllUI(); });
}
function updateBudgetSummary() {
    const spent = expenses.reduce((s,e)=>s+e.amount,0);
    const rem = monthlyIncome - spent;
    document.getElementById('total-spent').textContent = spent.toFixed(2)+' ‚Ç¨';
    const el = document.getElementById('remaining-budget');
    el.textContent = rem.toFixed(2)+' ‚Ç¨';
    el.className = `text-2xl font-bold mt-1 ${rem<0?'text-red-600':(rem<monthlyIncome*0.1?'text-yellow-600':'text-green-600')}`;
}

function renderTable() {
    const body = document.getElementById('expense-table-body'); body.innerHTML = '';
    const list = [...expenses].sort((a,b)=>new Date(b.date)-new Date(a.date));
    if(list.length===0) { body.innerHTML='<tr><td colspan="2" class="p-4 text-gray-500">≈Ωiadne d√°ta</td></tr>'; return; }
    list.forEach(e => {
        const tr = document.createElement('tr');
        tr.className = 'border-b hover:bg-gray-50';
        tr.innerHTML = `<td class="py-3 px-6 text-left whitespace-nowrap">${new Date(e.date).toLocaleDateString('sk-SK')} - ${e.category}</td><td class="py-3 px-6 text-left text-red-600 font-bold">-${e.amount.toFixed(2)} ‚Ç¨</td>`;
        body.appendChild(tr);
    });
}

function updateChart() {
    if(typeof Highcharts === 'undefined') return;
    const totals = expenses.reduce((acc,e)=>{ acc[e.category]=(acc[e.category]||0)+e.amount; return acc; }, {});
    const data = Object.entries(totals).sort((a,b)=>b[1]-a[1]);
    const finalData = data.length ? data : [['≈Ωiadne d√°ta', 1]];
    const total = finalData.reduce((s,i)=>s+(i[0]==='≈Ωiadne d√°ta'?0:i[1]),0);
    const isMobile = window.innerWidth < 768;

    Highcharts.chart('myChart', {
        chart: { 
            type: 'pie', backgroundColor: 'transparent',
            options3d: { enabled: true, alpha: 45, beta: 0 },
            margin: isMobile ? [30, 0, 30, 0] : [40, 40, 40, 40]
        },
        exporting: { enabled: false },
        title: { text: null },
        plotOptions: {
            pie: {
                // üî• TOTO JE KƒΩ√öƒåOV√Å ZMENA PRE MOBIL:
                // Zmen≈°en√≠m na 50% (namiesto 70%) z√≠skame miesto po bokoch pre text "Darƒçek pre mamku"
                size: isMobile ? '50%' : '60%', 
                depth: 45,
                dataLabels: {
                    enabled: true,
                    // üî• Zn√≠≈æime distance na 5px, aby boli nalepen√© pri grafe a nevybiehali von
                    distance: isMobile ? 5 : 30,
                    connectorPadding: 0,
                    format: isMobile 
                         ? '<div style="text-align: center;"><b>{point.name}</b><br>{point.percentage:.1f}%</div>' 
                         : '<b>{point.name}</b>: {point.percentage:.1f} %',
                    style: {
                        color: '#333',
                        fontWeight: 'normal',
                        fontSize: isMobile ? '10px' : '12px',
                        // üî• Zalom√≠me text sk√¥r, aby nebol dlh√Ω "sl√≠≈æ" do strany
                        width: isMobile ? '70px' : '120px'
                    }
                }
            }
        },
        series: [{ name: 'Suma', data: finalData }]
    });

    const legend = document.getElementById('custom-legend-container');
    if(legend) {
        legend.innerHTML = '';
        const colors = Highcharts.getOptions().colors;
        data.forEach((item, idx) => {
            const div = document.createElement('div');
            div.className = 'flex justify-between p-3 bg-gray-50 border rounded';
            div.innerHTML = `<div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full" style="background:${colors[idx%colors.length]}"></div><span>${item[0]}</span></div><span class="font-bold">${item[1].toFixed(2)} ‚Ç¨</span>`;
            legend.appendChild(div);
        });
    }
}

// ... (updateBudgetRuleChart, updateBudgetStatus, renderUI, print function atd...)
function updateBudgetRuleChart() { /* ... k√≥d pre stƒ∫pcov√Ω graf (nezmenen√Ω) ... */ 
    const ctx = document.getElementById('budget-bar-chart'); if(!ctx) return;
    const cats = Object.keys(monthlyBudget);
    if(cats.length===0) { document.getElementById('budget-bar-chart-container').classList.add('hidden'); return; }
    document.getElementById('budget-bar-chart-container').classList.remove('hidden');
    if(budgetChart) budgetChart.destroy();
    budgetChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: cats,
            datasets: [
                { label: 'Rozpoƒçet', data: cats.map(c=>monthlyBudget[c]), backgroundColor: 'rgba(75, 192, 192, 0.5)' },
                { label: 'Minut√©', data: cats.map(c=>expenses.filter(e=>e.category===c).reduce((s,i)=>s+i.amount,0)), backgroundColor: 'rgba(255, 99, 132, 0.5)' }
            ]
        }
    });
}
function updateBudgetStatus() {
    const el = document.getElementById('budget-status-container'); el.innerHTML = '';
    Object.keys(monthlyBudget).forEach(c => {
        const b = monthlyBudget[c], s = expenses.filter(e=>e.category===c).reduce((a,i)=>a+i.amount,0);
        const p = Math.min((s/b)*100, 100);
        const div = document.createElement('div');
        div.className = 'bg-white p-3 border rounded';
        div.innerHTML = `<div class="flex justify-between mb-1"><span>${c}</span><span class="${s>b?'text-red-600':'text-green-600'} font-bold">${(b-s).toFixed(2)} ‚Ç¨ ost√°va</span></div><div class="w-full bg-gray-200 h-2 rounded"><div class="h-2 rounded ${s>b?'bg-red-500':'bg-green-500'}" style="width:${p}%"></div></div>`;
        el.appendChild(div);
    });
}
function updateCycleDatesDisplay(s=cycleStartDate,e=null) {
    document.getElementById('cycle-dates').textContent = s ? `Cyklus: ${s.toLocaleDateString()}${e?' - '+e.toLocaleDateString():''}` : 'Zaƒçnite pridan√≠m d√°t.';
}
function renderUI() {
    const sel = document.getElementById('expense-category');
    const curr = sel.value; sel.innerHTML = '';
    getAllCategories().forEach(c => sel.innerHTML+=`<option value="${c}">${c}</option>`);
    sel.innerHTML+=`<option value="${CUSTOM_CATEGORY_OPTION}">-- Vlastn√° --</option>`;
    if(curr && (getAllCategories().includes(curr)||curr===CUSTOM_CATEGORY_OPTION)) sel.value=curr;
    
    const budSel = document.getElementById('budget-category-select');
    budSel.innerHTML = ''; getAllCategories().forEach(c => budSel.innerHTML+=`<option value="${c}">${c}</option>`);
}

async function handlePrintChartAndTable() {
    // Jednoduch√° implement√°cia tlaƒçe
    window.print();
}

document.addEventListener('DOMContentLoaded', () => {
    loadDataFromLocalStorage(); renderAllUI();
    document.getElementById('add-expense-btn').onclick = handleAddExpense;
    document.getElementById('save-income-btn').onclick = handleSaveIncome;
    document.getElementById('save-budget-btn').onclick = handleSaveBudget;
    document.getElementById('delete-current-cycle-btn').onclick = handleDeleteCurrentCycle;
    document.getElementById('start-new-cycle-btn').onclick = startNewCycle;
    document.getElementById('view-history-btn').onclick = () => { renderHistorySidebar(); document.getElementById('history-sidebar').classList.remove('translate-x-full'); };
    document.getElementById('close-history-btn').onclick = () => document.getElementById('history-sidebar').classList.add('translate-x-full');
    document.getElementById('back-to-current-btn').onclick = backToCurrentCycle;
    document.getElementById('delete-history-btn').onclick = handleDeleteHistory;
    document.getElementById('print-all-btn').onclick = handlePrintChartAndTable;
    document.getElementById('expense-category').onchange = (e) => document.getElementById('custom-category-input-group').classList.toggle('hidden', e.target.value !== CUSTOM_CATEGORY_OPTION);
    window.onresize = updateChart;
});
</script>
</body>
</html>



